<!DOCTYPE html>
<html lang="en">

<head>
    <title>CW 2 - Individual</title>
    <script src="https://unpkg.com/vue"> </script>
    <link href="https://fonts.googleapis.com/css?family=Open+Sans" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <!--Import Materialize CSS Stylesheet-->
    <link type="text/css" rel="stylesheet" href="css/materialize.min.css" />
    <!-- Font Awesome icon -->
    <link type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css"
    rel="stylesheet">

   
</head>

<body>
    <div id="app">

        <!-- shoping cart -->
        <header>
            <h1>{{sitename}}</h1>
            <button  v-on:click="showcheckout" v-if="enableshoppingcart">shopping cart</button>
            <P v-else>Shopping Cart</P>
            <div v-for="product in cart" style="display:inline-block;">
                <figure>
                    <img v-bind:src="product.image" width="200" height="200">
                </figure>
                <h2 v-html="product.subject"></h2>
               <span> <P>Locatioc:{{product.location}}</P>
                <p>Price:{{product.price}}</p>
                <P>Number of spaces: {{product.availableInventory}}</P>
            </span>
                <button class="fa fa-trash" v-on:click="removefromcart(product)"> Remove Product</button>
            </div>
        </header>

        <main>
            <div v-if="showproduct">

                <div v-for="product in products">

                    <figure>
                        <img v-bind:src="product.image" width="200" height="200">
                    </figure>

                    <h2 v-html="product.subject"></h2>
                    <p>ID : {{ product._id}}</p>
                    <P>Location: {{product.location}}</P>
                    <p>Price: {{product.price}}</p>
                    <P>Number of spaces: {{product.availableInventory}}</P>
                    <button v-on:click="decrement_inventory(product); addtocart(product); " v-if="isenable(product)">
                        ADD TO CART</button>
                    <!-- only show the button when 'canAddToCart' is true when it becomes false the button disappers -->

                    <button disabled="disabled" v-else>DISABLE</button>
                </div>
            </div>

            <div v-else>
                <h2>Checkout</h2>


                <form @submit="submitForm">
                    <ul>
                        <p>
                            <strong>Name:</strong>
                            <input id="name" required v-model.trim="order.name" type="text" />
                        </p>
                        <p><strong>Phone : </strong><input id="phone" required v-model.number='order.phone'
                                type="number"></p>


                        <input type="submit">
                </form>

            </div>
        </main>
    </div>


    <script type="text/javascript">
        const info = new Vue({
            el: '#app',
            data: {
                sitename: 'Lessons',
                lessons: [],
                cart: [],
                showProduct: false,
                order: {
                    firstName: '',
                    lastName: '',
                },
                sort: 'ascending',
                type: '',
                user: {
                    name: '',
                    number: ''
                }
            },
            methods: {
                addToCart(lesson) {
                    this.lessons.find(item => item.id == lesson.id).availableInventory -= 1;
                    this.cart.push({ cartId: (this.cart.length + 1), ...lesson });
                },
                removeToCart(lesson) {
                    if (confirm('Do you want to delete this?')) {
                        this.cart = [...this.cart].filter(item => item.cartId != lesson.cartId)
                    }
                },
                showCheckout() {
                    this.showProduct = !this.showProduct;
                },
                submit() {
                    if (this.phonenumber(this.user.number)) {
                        alert('Order submited.')
                        console.log(this.user);
                    }
                },
                phonenumber(number) {
                    let phoneno = /^\d{11}$/;
                    if ((number.match(phoneno))) {
                        return true;
                    }
                    else {
                        alert("Phone number invalid.");
                        return false;
                    }
                }

            },
            computed: {
                total() {
                    return this.cart.length > 0 ? this.cart.map(item => item.price).reduce((acc, cur) => acc + cur) : 0;
                },
                sortedLessons() {
                    switch (this.type) {
                        case 'subject':
                            return this.lessons.sort((a, b) => {
                                switch (this.sort) {
                                    case 'ascending':
                                        return a.subject.toUpperCase() > b.subject.toUpperCase() ? 1 : -1;
                                    default:
                                        return a.subject.toUpperCase() < b.subject.toUpperCase() ? 1 : -1;
                                }
                            })
                        case 'location':
                            return this.lessons.sort((a, b) => {
                                switch (this.sort) {
                                    case 'ascending':
                                        return a.location.toUpperCase() > b.location.toUpperCase() ? 1 : -1;
                                    default:
                                        return a.location.toUpperCase() < b.location.toUpperCase() ? 1 : -1;
                                }
                            })
                        case 'price':
                            return this.lessons.sort((a, b) => {
                                return this.sort == 'ascending' ? a.price - b.price : b.price - a.price;
                            })
                        case 'space':
                            return this.lessons.sort((a, b) => {
                                return this.sort == 'ascending' ? a.availableInventory - b.availableInventory : b.availableInventory - a.availableInventory;
                            })
                        default:
                            return this.lessons.sort((a, b) => {
                                return this.sort == 'ascending' ? a.id - b.id : b.id - a.id;
                            })
                    }
                }
            },
            created() {
                this.lessons = lessons
            }
        });
                    const newavailableInventory = product.availableInventory;


                    fetch('https://moscst3145.herokuapp.com/collection/products/' + product._id, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ availableInventory: newavailableInventory })
                    }).then(function (data) {
                     
                     
                    });


                },
                showcheckout() {
                    this.showproduct = this.showproduct ? false : true;
                },
                removefromcart: function (product) {

                    product.availableInventory = product.availableInventory + 1;
                    const newavail = product.availableInventory;
                    this.cart.pop(product)
                    fetch('https://moscst3145.herokuapp.com/collection/products/' + product._id, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ availableInventory: newavail })
                    }).then(function (data) {
                   
                       

                    });


                },


                submitForm() {
                    fetch('https://moscst3145.herokuapp.com/collection/orders', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ Name: this.order.name, Phone: this.order.phone, ProductsInOrders: this.cart.map(({ subject }) => subject) })}).then(function () {


                    });

                    this.cart.forEach(element => {

                        fetch('https://moscst3145.herokuapp.com/collection/products/' + element._id, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ availableInventory: element.availableInventory })}).then(function (data) {
                         

                        });

                    });


                    alert('Order submitted')
                },

                cartCount(id) {
                    let count = 0;
                    for (let i = 0; i < this.cartID.length; i++) {
                        if (this.cartID[i] === id) {
                            count++
                        }
                    }
                    return count;
                },

            },

            computed: {
                enableshoppingcart: function () {
                    if (this.cart.length > 0) {
                        return true
                    }
                    else {
                        return false
                    }
                },


            },

            created: function () {

                fetch('https://moscst3145.herokuapp.com/collection/products').then(
                    function (response) {
                        response.json().then(
                            function (json) {
                                webstore.products = json;
                               
                            });
                    });

            }


        });

    </script>

</body>

</html>
